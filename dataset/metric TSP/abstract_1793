On metric spaces equipped with doubling measures, we prove that a
differentiability theorem holds for Lipschitz functions if and only if the
space supports nontrivial (metric) derivations in the sense of Weaver that
satisfy an additional infinitesmal condition. In particular it extends the case
of spaces supporting Poincar\'e inequalities, as first proven by Cheeger, as
well as the case of spaces satisfying the Lip-lip condition of Keith.
  The proof relies on generalised "change of variable" arguments that are made
possible by the linear algebraic structure of derivations. As a crucial step in
the argument, we also prove new rank bounds for derivations with respect to
doubling measures.
  (Note: this is an updated version of an earlier preprint, titled
"Differentiability of Lipschitz functions on doubling metric measure spaces."
The edits are listed in the comments.)