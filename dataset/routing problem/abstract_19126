We investigate the problem of predicting the halo mass function from the
properties of the Lagrangian density field. We focus on a perturbation spectrum
with a small-scale cut-off (as in warm dark matter cosmologies). This cut-off
results in a strong suppression of low mass objects, providing additional
leverage to rigorously test which perturbations collapse and to what mass. We
find that all haloes are consistent with forming near peaks of the initial
density field, with a strong correlation between proto-halo density and
ellipticity. We demonstrate that, while standard excursion set theory with
correlated steps completely fails to reproduce the mass function, the inclusion
of the peaks constraint leads to the correct number of haloes but significantly
underpredicts the masses of low-mass objects (with the predicted halo mass
function at low masses behaving like dn/dln m ~ m^{2/3}). This prediction is
very robust and cannot be easily altered within the framework of a single
collapse barrier. The nature of collapse in the presence of a small-scale
cut-off thus reveals that excursion set calculations require a more detailed
understanding of the collapse-time of a general ellipsoidal perturbation to
predict the ultimate collapsed mass of a peak -- a problem that has been hidden
in the large abundance of small-scale structure in CDM. We demonstrate how this
problem can be resolved within the excursion set framework.