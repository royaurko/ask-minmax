  We propose an iterated local search algorithm for the vehicle routing problem with time window constraints. We treat the time window constraint for each customer as a penalty function, and assume that it is convex and piecewise linear. Given an order of customers each vehicle to visit, dynamic programming (DP) is used to determine the optimal start time to serve the customers so that the total time penalty is minimized. This DP algorithm is then incorporated in the iterated local search algorithm to efficiently evaluate solutions in various neighborhoods. The amortized time complexity of evaluating a solution in the neighborhoods is a logarithmic order of the input size (i.e., the total number of linear pieces that define the penalty functions). Computational comparisons on benchmark instances with up to 1000 customers show that the proposed method is quite effective, especially for large instances. Keywords Vehicle routing problem with time windows ; Metaheuristics ; Dynamic programming 1. Introduction The vehicle routing problem (VRP) is the problem of minimizing the total distance traveled by a number of vehicles, under various constraints, where each customer must be visited exactly once by a vehicle. This is one of the representative combinatorial optimization problems and is known to be NP-hard. Among variants of VRP, the VRP with capacity and time window constraints, called the vehicle routing problem with time windows (VRPTW), has been widely studied in the last decade. The capacity constraint signifies that the total load on a route cannot exceed the capacity of the vehicle serving the route. The time window constraint signifies that each vehicle must start the service at each customer in the period specified by the customer. The VRPTW has a wide range of applications such as bank deliveries, postal deliveries, school bus routing and so on. For an extensive survey on heuristic and metaheuristic approaches for the VRPTW, see Refs. [5]  and  [6] . If the capacity and time window constraints must be satisfied strictly, such problem is called the VRPHTW (H stands for hard). For this problem, even just finding a feasible solution with a given number of vehicles is known to be NP-complete, because it includes the (one-dimensional) bin packing problem [10] as a special case. Thus, it is inefficient to search only within the feasible region of the VRPHTW, especially when the constraints are tight. Moreover, in many real-world situations, these constraints can be violated to some extent. Considering these, we treat these two types of constraints as soft (i.e., can be violated) in this paper. This problem is called the VRPSTW (S stands for soft), and the amount of violation of soft constraints is penalized by using penalty functions and added to the objective function. In this case, it is not trivial to determine the optimal start time of services at all customers so that the total penalty is minimized after fixing the order of customers for each vehicle to visit. The time penalty function is the function that penalizes the amount of violation of time window constraints for customers. In most of the previous work for the VRPTW [23] , [28] , [29]  and  [31] , only one time window is allowed for each customer and in this case the time penalty function is convex. In the literature [8] , [11] , [23]  and  [31] , algorithms for particular convex time penalty functions were proposed in order to treat the time window constraint as a soft constraint. In [31] , the time penalty for each customer is +∞ + ∞ for earliness and linear for tardiness, and an O(1) O ( 1 ) time algorithm to compute approximately the optimal time penalty for a solution in neighborhoods was proposed. In [8]  and  [23] , the time penalty is linear for both of earliness and tardiness, and O ( n k 2 ) time algorithms to compute the penalty of a given route of vehicle k   were proposed, where n k n k is the number of customers assigned to vehicle k . If the time penalty function for each customer is the absolute deviation from a specified time, the problem to determine the optimal start time of services at all customers is called the isotonic median regression problem , which has been extensively studied. To our knowledge, the best time complexity for this problem (for a vehicle k   ) is O(n k logn k ) O ( n k log n k ) [1] , [11]  and  [17] .